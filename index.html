<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ラヴィPG 指名フローチャート（デモ）</title>
  style.css
  <meta name="format-detection" content="telephone=no">
</head>
<body>
  <main class="app">
    <header>
      <h1>PG指名フローチャート（デモ）</h1>
      <p class="sub">4つの質問に答えると、おすすめPGを表示します。</p>
    </header>

    <section id="card" class="card hidden"></section>

    <section id="result" class="hidden">
      <h2>おすすめのPG</h2>
      <div id="pgList" class="pg-list"></div>
      <button id="restart" class="ghost">最初からやり直す</button>
    </section>

    <footer>
      <small>※デモ用：結果画面から公式サイトの作品ページにリンクします</small>
    </footer>
  </main>

  <script>
    // ---- 状態管理（“results方式”：分岐が確定したらID配列で結果を表示） ----
    const state = { step: "q1", results: null };

    // GitHub Pagesのキャッシュが強いので、都度クエリを付けて取得
    async function loadData() {
      const res = await fetch('data.json?_=' + Date.now());
      if (!res.ok) throw new Error("data.json を読み込めませんでした");
      return await res.json();
    }

    function findNode(data, id) {
      return data.nodes.find(n => n.id === id);
    }

    function resolvePhotographers(data, ids) {
      const map = new Map(data.photographers.map(p => [p.id, p]));
      return ids.map(id => map.get(id)).filter(Boolean);
    }

    function renderQuestion(node) {
      const el = document.getElementById('card');
      el.innerHTML = `
        <h2>${node.question}</h2>
        <div class="choices">
          ${node.choices.map(c => `
            <button class="choice"
              data-next='${c.next || ""}'
              data-results='${c.results ? JSON.stringify(c.results) : ""}'>
              ${c.label}
            </button>
          `).join('')}
        </div>
        <div class="progress">${node.progress || ""}</div>
      `;
      el.classList.remove('hidden');

      // ボタンクリックで次へ
      document.querySelectorAll('.choice').forEach(btn => {
        btn.onclick = (e) => {
          const target = e.currentTarget;
          const resultsStr = target.getAttribute('data-results');

          if (resultsStr) {
            // ここで最終結果が確定
            try {
              state.results = JSON.parse(resultsStr);
            } catch {
              state.results = [];
            }
            state.step = "FINAL";
            run();
            return;
          }

          const next = target.getAttribute('data-next');
          state.step = next || "FINAL";
          run();
        };
      });
    }

    function renderResult(data) {
      const ids = Array.isArray(state.results) ? state.results : [];
      const list = ids.length ? resolvePhotographers(data, ids) : [];

      const wrap = document.getElementById('pgList');
      wrap.innerHTML = list.map(p => `
        <article class="pg">
          <div class="pg-meta">
            <h3>${p.name}</h3>
            ${p.comment ? `<p class="comment">${p.comment}</p>` : ``}
          </div>
          ${p.portfolio_url ? `
            ${p.portfolio_url}
              作品を見る
            </a>` : `<span class="btn disabled" title="URL未設定">作品リンク準備中</span>`
          }
        </article>
      `).join('') || `<p>該当のPGが見つかりませんでした。</p>`;

      document.getElementById('card').classList.add('hidden');
      const r = document.getElementById('result');
      r.classList.remove('hidden');

      document.getElementById('restart').onclick = () => {
        state.step = "q1";
        state.results = null;
        document.getElementById('result').classList.add('hidden');
        run();
      };
    }

    async function run() {
      try {
        const data = await loadData();

        if (state.step === "FINAL") {
          return renderResult(data);
        }

        const node = findNode(data, state.step);
        if (!node) {
          state.step = "FINAL";
          return renderResult(data);
        }
        renderQuestion(node);
      } catch (e) {
        console.error(e);
        alert("データの読み込みに失敗しました。少し時間をおいて再読み込みしてください。");
      }
    }

    run();
  </script>
</body>
</html>
