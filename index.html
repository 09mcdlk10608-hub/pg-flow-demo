<script>
  const state = { step: "q1", results: null };

  async function loadData() {
    const res = await fetch('data.json?_=' + Date.now()); // キャッシュ回避
    return await res.json();
  }

  function findNode(data, id) {
    return data.nodes.find(n => n.id === id);
  }

  function resolvePhotographers(data, ids) {
    const map = Object.fromEntries(data.photographers.map(p => [p.id, p]));
    return ids.map(id => map[id]).filter(Boolean);
  }

  function renderQuestion(node) {
    const el = document.getElementById('card');
    el.innerHTML = `
      <h2>${node.question}</h2>
      <div class="choices">
        ${node.choices.map(c => `
          <button class="choice"
                  data-next='${c.next || ""}'
                  data-results='${c.results ? JSON.stringify(c.results) : ""}'>
            ${c.label}
          </button>
        `).join('')}
      </div>
      <div class="progress">${node.progress || ""}</div>
    `;
    el.classList.remove('hidden');

    document.querySelectorAll('.choice').forEach(btn => {
      btn.onclick = (e) => {
        const resultsStr = e.currentTarget.getAttribute('data-results');
        if (resultsStr) {
          state.results = JSON.parse(resultsStr);
          state.step = "FINAL";
          run();
          return;
        }
        const next = e.currentTarget.getAttribute('data-next');
        state.step = next || "FINAL";
        run();
      };
    });
  }

  function renderResult(data) {
    // 明示的な results がある場合はそれを使う
    const ids = state.results && state.results.length ? state.results : [];
    const list = ids.length ? resolvePhotographers(data, ids) : [];

    const wrap = document.getElementById('pgList');
    wrap.innerHTML = list.map(p => `
      <article class="pg">
        <div class="pg-meta">
          <h3>${p.name}</h3>
          ${p.comment ? `<p class="comment">${p.comment}</p>` : ``}
        </div>
        ${p.portfolio_url ? `
          ${p.portfolio_url}
            作品を見る
          </a>` : `<span class="btn disabled" title="URL未設定">作品リンク準備中</span>`
        }
      </article>
    `).join('') || `<p>該当のPGが見つかりませんでした。</p>`;

    document.getElementById('card').classList.add('hidden');
    const r = document.getElementById('result');
    r.classList.remove('hidden');

    document.getElementById('restart').onclick = () => {
      state.step = "q1";
      state.results = null;
      document.getElementById('result').classList.add('hidden');
      run();
    };
  }

  async function run() {
    const data = await loadData();

    if (state.step === "FINAL") {
      return renderResult(data);
    }

    const node = findNode(data, state.step);
    if (!node) {
      state.step = "FINAL";
      return renderResult(data);
    }
    renderQuestion(node);
  }

  run();
</script>
